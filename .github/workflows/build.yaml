name: build and pushes ECR

on:
  # push:
  #   branches:
  #     - master 
  # pull_request:
  #   branches:
  #     - master

   workflow_dispatch:

jobs:
  build:
    runs-on: [ubuntu-runner]
    permissions:
        id-token: write
        contents: read
    
    steps:
      - name: checkout
        uses: actions/checkout


      - name: generate oidc token
        shell: bash 
        run: |
          # Ask GitHub for a JWT OIDC token with AWS's audience
          TOK_JSON=$(curl -sS -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=sts.amazonaws.com")

          # Extract token without printing it
          JWT=$(echo "$TOK_JSON" | jq -r '.value')

          # Decode JWT payload (claims) safely and show key fields
          echo "$JWT" | \
            awk -F. '{print $2}' | tr '_-' '/+' | base64 -d 2>/dev/null | \
            jq '{iss, aud, sub, exp}'


