name: Terraform Common
description: Run terraform plan or apply

inputs:
  action:
    required: true
  tf_var_file:
    required: false

runs:
  using: "composite"
  steps:

    - name: Set working directory
      run: echo "WORKSPACE=${GITHUB_WORKSPACE}" 
      shell: bash

    - uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.7

    - uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: "arn:aws:iam::424851482428:role/abc"
        aws-region: us-east-1

    - name: Terraform Init
      run: terraform init
      shell: bash
      working-directory: ${{ github.workspace }}

    - name: Run Terraform
      shell: bash
      working-directory: ${{ github.workspace }}
      run: |
        if [[ "${{ inputs.action }}" == "plan" ]]; then
          terraform plan -var-file="${{ inputs.tf_var_file }}" -out=tfplan
        elif [[ "${{ inputs.action }}" == "apply" ]]; then
          terraform apply "tfplan"
        fi
